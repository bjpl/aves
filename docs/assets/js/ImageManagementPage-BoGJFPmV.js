import{r as e,j as s,L as a}from"./react-vendor-DQuyXcEf.js";import{u as t}from"./useSupabaseAuth-CqgoJLqK.js";import{L as n,u as l}from"./useSpecies-c6-vRY5l.js";import{a as i,B as r,C as o,b as d,c,d as m}from"./Badge-DuILK2iM.js";import{B as x,A as g,u as h,T as u}from"./ToastContainer-BqIwOpMe.js";import{a as p,u as j,b as y}from"./data-vendor-CMzD5k4W.js";import{e as b}from"./index-BgNPggoK.js";import"./vendor-Sp3tVij8.js";import"./apiAdapter-CFFXV68q.js";const v={all:["image-management"],dashboard:()=>[...v.all,"dashboard"],stats:()=>[...v.all,"stats"],quota:()=>[...v.all,"quota"],jobs:()=>[...v.all,"jobs"],pendingImages:()=>[...v.all,"pending-images"],gallery:(e,s,a)=>[...v.all,"gallery",{page:e,status:s,speciesId:a}]},f=()=>{const e=p(),{data:s,isLoading:a,refetch:t}=j({queryKey:v.dashboard(),queryFn:async()=>{try{return(await i.get("/api/admin/dashboard")).data.data}catch(e){return b("Error fetching dashboard:",e instanceof Error?e:new Error(String(e))),{stats:{totalImages:0,pendingAnnotation:0,annotated:0,failed:0,bySpecies:{}},quota:{unsplash:{remaining:50,limit:50,resetTime:null},anthropic:{remaining:1e3,limit:1e3,resetTime:null}},jobs:[],hasActiveJobs:!1}}},staleTime:3e4,gcTime:3e5}),n=s?.hasActiveJobs||!1,{data:l}=((e=!1)=>j({queryKey:v.jobs(),queryFn:async()=>{try{return(await i.get("/api/admin/images/jobs")).data.jobs}catch(e){return b("Error fetching jobs:",e instanceof Error?e:new Error(String(e))),[]}},staleTime:1e4,gcTime:3e5,refetchInterval:!!e&&3e3}))(n),r=n&&l?l:s?.jobs||[],{data:o=[]}=j({queryKey:v.pendingImages(),queryFn:async()=>{try{return(await i.get("/api/admin/images/pending")).data.data}catch(e){return b("Error fetching pending images:",e instanceof Error?e:new Error(String(e))),[]}},staleTime:3e4,gcTime:3e5}),d=(()=>{const e=p();return y({mutationFn:async e=>(await i.post("/api/admin/images/collect",e)).data.data,onSuccess:()=>{e.invalidateQueries({queryKey:v.dashboard()}),e.invalidateQueries({queryKey:v.jobs()}),e.invalidateQueries({queryKey:v.stats()}),e.invalidateQueries({queryKey:v.quota()})},onError:e=>{b("Error starting image collection:",e instanceof Error?e:new Error(String(e)))}})})(),c=(()=>{const e=p();return y({mutationFn:async e=>(await i.post("/api/admin/images/annotate",e)).data.data,onSuccess:()=>{e.invalidateQueries({queryKey:v.dashboard()}),e.invalidateQueries({queryKey:v.jobs()}),e.invalidateQueries({queryKey:v.stats()}),e.invalidateQueries({queryKey:v.quota()}),e.invalidateQueries({queryKey:v.pendingImages()})},onError:e=>{b("Error starting annotation:",e instanceof Error?e:new Error(String(e)))}})})(),m=(()=>{const e=p();return y({mutationFn:async e=>(await i.post("/api/admin/images/bulk/delete",{imageIds:e})).data,onSuccess:()=>{e.invalidateQueries({queryKey:v.all})},onError:e=>{b("Error deleting images:",e instanceof Error?e:new Error(String(e)))}})})(),x=(()=>{const e=p();return y({mutationFn:async e=>(await i.post("/api/admin/images/bulk/annotate",{imageIds:e})).data,onSuccess:()=>{e.invalidateQueries({queryKey:v.dashboard()}),e.invalidateQueries({queryKey:v.jobs()}),e.invalidateQueries({queryKey:v.stats()})},onError:e=>{b("Error starting bulk annotation:",e instanceof Error?e:new Error(String(e)))}})})();return{stats:s?.stats,quota:s?.quota,jobs:r,pendingImages:o,isLoading:a,hasActiveJobs:n,refetchStats:()=>(e.invalidateQueries({queryKey:v.dashboard()}),t()),collectMutation:d,annotateMutation:c,bulkDeleteMutation:m,bulkAnnotateMutation:x}},N=({species:a,selected:t,onChange:n,disabled:l=!1})=>{const[i,o]=e.useState(""),[d,c]=e.useState(!1),m=a.filter(e=>e.englishName?.toLowerCase().includes(i.toLowerCase())||e.spanishName?.toLowerCase().includes(i.toLowerCase())||e.scientificName?.toLowerCase().includes(i.toLowerCase()));return s.jsxs("div",{className:"relative",children:[s.jsxs("div",{className:"border rounded-lg p-3 cursor-pointer "+(l?"bg-gray-100 cursor-not-allowed":"bg-white hover:border-blue-500"),onClick:()=>!l&&c(!d),children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-gray-700",children:0===t.length?"Select species...":`${t.length} species selected`}),s.jsx("svg",{className:"w-5 h-5 text-gray-400 transition-transform "+(d?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),t.length>0&&s.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[t.slice(0,5).map(e=>{const t=a.find(s=>s.id===e);return s.jsx(r,{variant:"primary",size:"sm",children:t?.englishName||e},e)}),t.length>5&&s.jsxs(r,{variant:"default",size:"sm",children:["+",t.length-5," more"]})]})]}),d&&!l&&s.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-80 overflow-hidden",children:[s.jsx("div",{className:"p-2 border-b",children:s.jsx("input",{type:"text",placeholder:"Search species...",className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none",value:i,onChange:e=>o(e.target.value),onClick:e=>e.stopPropagation()})}),s.jsxs("div",{className:"p-2 border-b flex gap-2",children:[s.jsx("button",{type:"button",className:"text-sm text-blue-600 hover:text-blue-800",onClick:e=>{e.stopPropagation(),n(m.map(e=>e.id))},children:"Select All"}),s.jsx("span",{className:"text-gray-300",children:"|"}),s.jsx("button",{type:"button",className:"text-sm text-gray-600 hover:text-gray-800",onClick:e=>{e.stopPropagation(),n([])},children:"Clear All"})]}),s.jsxs("div",{className:"max-h-52 overflow-y-auto",children:[m.map(e=>s.jsxs("label",{className:"flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer",onClick:e=>e.stopPropagation(),children:[s.jsx("input",{type:"checkbox",checked:t.includes(e.id),onChange:()=>{return s=e.id,void(t.includes(s)?n(t.filter(e=>e!==s)):n([...t,s]));var s},className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"}),s.jsxs("span",{className:"ml-3",children:[s.jsx("span",{className:"font-medium",children:e.englishName}),s.jsx("span",{className:"text-gray-500 text-sm ml-2",children:e.scientificName})]})]},e.id)),0===m.length&&s.jsx("div",{className:"px-3 py-4 text-center text-gray-500",children:"No species found"})]})]})]})},w=({selectedCount:e,onSelectAll:a,onDeselectAll:t,onDelete:n,onAnnotate:l,isDeleting:i,isAnnotating:r,totalCount:o,allSelected:d})=>0===e?null:s.jsx("div",{className:"sticky top-[140px] z-20 bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 shadow-sm",children:s.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs("span",{className:"font-medium text-blue-900",children:[e," image",1!==e?"s":""," selected"]}),s.jsxs("div",{className:"flex gap-2",children:[!d&&o>0&&s.jsxs("button",{type:"button",onClick:a,className:"text-sm text-blue-600 hover:text-blue-800 underline",children:["Select all ",o]}),s.jsx("button",{type:"button",onClick:t,className:"text-sm text-gray-600 hover:text-gray-800 underline",children:"Deselect all"})]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(x,{variant:"secondary",size:"sm",onClick:l,isLoading:r,disabled:r||i,children:[s.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),"Annotate Selected"]}),s.jsxs(x,{variant:"danger",size:"sm",onClick:n,isLoading:i,disabled:r||i,children:[s.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Delete Selected"]})]})]})}),k=({isOpen:e,onClose:a,onConfirm:t,count:n,isDeleting:l})=>e?s.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[s.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:a}),s.jsxs("div",{className:"relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6",children:[s.jsxs("div",{className:"flex items-start gap-4",children:[s.jsx("div",{className:"flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center",children:s.jsx("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Delete ",n," image",1!==n?"s":"","?"]}),s.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"This action cannot be undone. All selected images and their associated annotations will be permanently deleted."})]})]}),s.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[s.jsx(x,{variant:"secondary",onClick:a,disabled:l,children:"Cancel"}),s.jsx(x,{variant:"danger",onClick:t,isLoading:l,disabled:l,children:"Delete"})]})]})]}):null,C=({className:e=""})=>s.jsx("div",{className:`animate-pulse bg-gray-200 rounded ${e}`}),S=()=>s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-4 text-center",children:[s.jsx(C,{className:"h-8 w-16 mx-auto mb-2"}),s.jsx(C,{className:"h-4 w-24 mx-auto"})]}),L=()=>s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsx(S,{}),s.jsx(S,{}),s.jsx(S,{}),s.jsx(S,{})]}),A=()=>s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{className:"h-4 w-32"}),s.jsx(C,{className:"h-10 w-full"})]}),P=()=>s.jsxs("div",{className:"border rounded-lg p-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx(C,{className:"h-5 w-24"}),s.jsx(C,{className:"h-5 w-16 rounded-full"})]}),s.jsx(C,{className:"h-2 w-full rounded-full mb-2"}),s.jsx(C,{className:"h-4 w-32"})]}),E=()=>s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[s.jsx(C,{className:"h-6 w-1/3 mb-2"}),s.jsx(C,{className:"h-4 w-2/3 mb-6"}),s.jsxs("div",{className:"space-y-4",children:[s.jsx(P,{}),s.jsx(P,{})]})]}),q=({count:e=8})=>s.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:Array.from({length:e}).map((e,a)=>s.jsx("div",{className:"aspect-square",children:s.jsx(C,{className:"h-full w-full rounded-lg"})},a))}),T=()=>s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{className:"h-4 w-24"}),s.jsx(C,{className:"h-3 w-full rounded-full"}),s.jsx(C,{className:"h-3 w-32"})]}),D=()=>s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[s.jsx(C,{className:"h-6 w-1/3 mb-2"}),s.jsx(C,{className:"h-4 w-2/3 mb-6"}),s.jsxs("div",{className:"space-y-4",children:[s.jsx(A,{}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{className:"h-4 w-40"}),s.jsx(C,{className:"h-10 w-full"}),s.jsx(C,{className:"h-3 w-48"})]})]}),s.jsx("div",{className:"mt-6 pt-4 border-t",children:s.jsx(C,{className:"h-10 w-40"})})]}),s.jsx(E,{})]}),I=()=>s.jsxs("div",{className:"space-y-6",children:[s.jsx(L,{}),s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[s.jsx(C,{className:"h-6 w-1/4 mb-2"}),s.jsx(C,{className:"h-4 w-1/3 mb-6"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsx(T,{}),s.jsx(T,{})]})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[s.jsx(C,{className:"h-6 w-1/3 mb-2"}),s.jsx(C,{className:"h-4 w-1/2 mb-6"}),s.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:Array.from({length:8}).map((e,a)=>s.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[s.jsx(C,{className:"h-6 w-8 mx-auto mb-1"}),s.jsx(C,{className:"h-3 w-20 mx-auto"})]},a))})]})]}),z=()=>s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(C,{className:"h-10 w-48"}),s.jsx(C,{className:"h-10 w-32"})]}),s.jsx(q,{count:12}),s.jsxs("div",{className:"flex justify-center gap-2",children:[s.jsx(C,{className:"h-10 w-24"}),s.jsx(C,{className:"h-10 w-10"}),s.jsx(C,{className:"h-10 w-10"}),s.jsx(C,{className:"h-10 w-10"}),s.jsx(C,{className:"h-10 w-24"})]})]}),F=()=>s.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[s.jsx(C,{className:"h-6 w-1/4 mb-2"}),s.jsx(C,{className:"h-4 w-1/3 mb-6"}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex gap-4 pb-3 border-b",children:[s.jsx(C,{className:"h-4 w-16"}),s.jsx(C,{className:"h-4 w-16"}),s.jsx(C,{className:"h-4 w-24"}),s.jsx(C,{className:"h-4 w-32"}),s.jsx(C,{className:"h-4 w-32"}),s.jsx(C,{className:"h-4 w-20"})]}),Array.from({length:5}).map((e,a)=>s.jsxs("div",{className:"flex gap-4 py-3 border-b border-gray-100",children:[s.jsx(C,{className:"h-5 w-16 rounded-full"}),s.jsx(C,{className:"h-5 w-16 rounded-full"}),s.jsx(C,{className:"h-3 w-24 rounded-full"}),s.jsx(C,{className:"h-4 w-32"}),s.jsx(C,{className:"h-4 w-32"}),s.jsx(C,{className:"h-4 w-20"})]},a))]})]}),M=({activeTab:e})=>{switch(e){case"collection":case"annotation":default:return s.jsx(D,{});case"gallery":return s.jsx(z,{});case"statistics":return s.jsx(I,{});case"history":return s.jsx(F,{})}},$=({value:e,max:a=100,size:t="md",variant:n="default",color:l="primary",showLabel:i=!1,label:r,animated:o=!1,className:d=""})=>{const c=Math.min(Math.max(e/a*100,0),100),m={primary:"bg-blue-600",success:"bg-green-500",warning:"bg-yellow-500",danger:"bg-red-600"},x={primary:"bg-gradient-to-r from-blue-400 to-blue-600",success:"bg-gradient-to-r from-green-400 to-green-600",warning:"bg-gradient-to-r from-yellow-400 to-yellow-600",danger:"bg-gradient-to-r from-red-400 to-red-600"};return s.jsxs("div",{className:d,children:[(i||r)&&s.jsxs("div",{className:"flex justify-between text-sm text-gray-600 mb-1",children:[s.jsx("span",{children:r||"Progress"}),s.jsxs("span",{children:[Math.round(c),"%"]})]}),s.jsx("div",{className:`w-full bg-gray-200 rounded-full overflow-hidden ${{sm:"h-1",md:"h-3",lg:"h-4"}[t]}`,children:s.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${"gradient"===n?x[l]:"striped"===n?`${m[l]} bg-[length:1rem_1rem] bg-[linear-gradient(45deg,rgba(255,255,255,.15)_25%,transparent_25%,transparent_50%,rgba(255,255,255,.15)_50%,rgba(255,255,255,.15)_75%,transparent_75%,transparent)]`:m[l]} ${o?"animate-pulse":""}`,style:{width:`${c}%`},role:"progressbar","aria-valuenow":e,"aria-valuemin":0,"aria-valuemax":a})})]})},B=({isOpen:a,onClose:t,title:n,size:l="md",showCloseButton:i=!0,closeOnOverlayClick:r=!0,closeOnEscape:o=!0,children:d,footer:c})=>{const m=e.useRef(null);if(e.useEffect(()=>{const e=e=>{o&&"Escape"===e.key&&t()};return a&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow="unset"}},[a,t,o]),!a)return null;return s.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true",children:[s.jsx("div",{className:"fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity",onClick:e=>{r&&e.target===e.currentTarget&&t()}}),s.jsx("div",{className:"flex min-h-screen items-center justify-center p-4",children:s.jsxs("div",{ref:m,className:`relative bg-white rounded-lg shadow-xl transform transition-all w-full ${{sm:"max-w-md",md:"max-w-lg",lg:"max-w-2xl",xl:"max-w-4xl",full:"max-w-full mx-4"}[l]}`,children:[(n||i)&&s.jsxs("div",{className:"flex items-start justify-between p-6 border-b border-gray-200",children:[n&&s.jsx("h3",{id:"modal-title",className:"text-xl font-semibold text-gray-900",children:n}),i&&s.jsx("button",{onClick:t,className:"ml-auto text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-1","aria-label":"Close modal",children:s.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),s.jsx("div",{className:"p-6 max-h-[calc(100vh-16rem)] overflow-y-auto",children:d}),c&&s.jsx("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50",children:c})]})})]})},O={all:["gallery"],list:e=>[...O.all,"list",e],detail:e=>[...O.all,"detail",e]},Q=({onFilesSelected:a,disabled:t})=>{const[n,l]=e.useState(!1),i=e.useRef(null),r=e.useCallback(e=>{e.preventDefault(),e.stopPropagation()},[]),o=e.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.items&&e.dataTransfer.items.length>0&&l(!0)},[]),d=e.useCallback(e=>{e.preventDefault(),e.stopPropagation(),l(!1)},[]),c=e.useCallback(e=>{if(e.preventDefault(),e.stopPropagation(),l(!1),t)return;const s=Array.from(e.dataTransfer.files).filter(e=>["image/jpeg","image/jpg","image/png","image/webp"].includes(e.type));s.length>0&&a(s)},[a,t]),m=e.useCallback(e=>{if(e.target.files&&e.target.files.length>0){const s=Array.from(e.target.files);a(s)}},[a]);return s.jsxs("div",{className:`\n        relative border-2 border-dashed rounded-lg p-8 text-center cursor-pointer\n        transition-all duration-200\n        ${n?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}\n        ${t?"opacity-50 cursor-not-allowed":""}\n      `,onDragEnter:o,onDragLeave:d,onDragOver:r,onDrop:c,onClick:()=>{t||i.current?.click()},children:[s.jsx("input",{ref:i,type:"file",multiple:!0,accept:"image/jpeg,image/jpg,image/png,image/webp",onChange:m,className:"hidden",disabled:t}),s.jsxs("div",{className:"space-y-3",children:[s.jsx("svg",{className:"w-12 h-12 mx-auto "+(n?"text-blue-500":"text-gray-400"),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})}),s.jsxs("div",{children:[s.jsx("p",{className:"text-lg font-medium text-gray-700",children:n?"Drop images here":"Drag & drop images here"}),s.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"or click to browse files"})]}),s.jsx("p",{className:"text-xs text-gray-400",children:"Supports: JPEG, PNG, WebP (max 10MB each, up to 20 files)"})]})]})},R=({files:e,onRemove:a,disabled:t})=>0===e.length?null:s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"flex items-center justify-between mb-2",children:s.jsxs("h4",{className:"text-sm font-medium text-gray-700",children:["Selected Files (",e.length,")"]})}),s.jsx("div",{className:"grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2 max-h-48 overflow-y-auto p-1",children:e.map(e=>s.jsxs("div",{className:"relative group aspect-square rounded-lg overflow-hidden border border-gray-200",children:[s.jsx("img",{src:e.preview,alt:e.file.name,className:"w-full h-full object-cover"}),!t&&s.jsx("button",{type:"button",onClick:()=>a(e.id),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity",children:s.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),s.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 px-1 py-0.5",children:s.jsx("p",{className:"text-xs text-white truncate",children:e.file.name})})]},e.id))})]}),K=({species:e,value:a,onChange:t,disabled:n})=>s.jsxs("div",{className:"mt-4",children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Species ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs("select",{value:a,onChange:e=>t(e.target.value),disabled:n,className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none disabled:bg-gray-100 disabled:cursor-not-allowed",children:[s.jsx("option",{value:"",children:"Select a species..."}),e.map(e=>s.jsxs("option",{value:e.id,children:[e.englishName," (",e.scientificName,")"]},e.id))]}),s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"All uploaded images will be associated with this species"})]}),U=({isOpen:a,onClose:t,species:n,onSuccess:l,onToast:r})=>{const[o,d]=e.useState([]),[c,m]=e.useState(""),[h,u]=e.useState(0),[j,v]=e.useState(null),f=(()=>{const e=p();return y({mutationFn:async({files:e,speciesId:s,onProgress:a})=>{const t=new FormData;return t.append("speciesId",s),e.forEach(e=>{t.append("files",e)}),(await i.post("/api/admin/images/upload",t,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:e=>{if(e.total&&a){const s=Math.round(e.loaded/e.total*100);a(s)}}})).data},onSuccess:()=>{e.invalidateQueries({queryKey:["image-management"]}),e.invalidateQueries({queryKey:["gallery"]})},onError:e=>{b("Error uploading images:",e instanceof Error?e:new Error(String(e)))}})})(),N=e.useCallback(e=>{const s=e.map(e=>({file:e,preview:URL.createObjectURL(e),id:`${e.name}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}));d(e=>[...e,...s].slice(0,20)),v(null)},[]),w=e.useCallback(e=>{d(s=>{const a=s.find(s=>s.id===e);return a&&URL.revokeObjectURL(a.preview),s.filter(s=>s.id!==e)})},[]),k=()=>{o.forEach(e=>URL.revokeObjectURL(e.preview)),d([]),m(""),u(0),v(null),t()},C=f.isPending,S=o.length>0&&c&&!C;return s.jsx(B,{isOpen:a,onClose:k,title:"Upload Images",size:"lg",closeOnOverlayClick:!C,closeOnEscape:!C,children:s.jsxs("div",{className:"space-y-4",children:[j&&s.jsx(g,{variant:"danger",onClose:()=>v(null),children:j}),s.jsx(Q,{onFilesSelected:N,disabled:C}),s.jsx(R,{files:o,onRemove:w,disabled:C}),s.jsx(K,{species:n,value:c,onChange:m,disabled:C}),C&&s.jsx("div",{className:"mt-4",children:s.jsx($,{value:h,max:100,variant:"gradient",color:"primary",showLabel:!0,label:"Uploading...",animated:!0})}),s.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[s.jsx(x,{variant:"secondary",onClick:k,disabled:C,children:"Cancel"}),s.jsxs(x,{variant:"primary",onClick:async()=>{if(0!==o.length)if(c){v(null),u(0);try{const e=await f.mutateAsync({files:o.map(e=>e.file),speciesId:c,onProgress:u});e.summary.successful>0&&(r("success",`Successfully uploaded ${e.summary.successful} image${1!==e.summary.successful?"s":""}`),l(),k()),e.failed&&e.failed.length>0&&r("error",`${e.failed.length} file${1!==e.failed.length?"s":""} failed to upload`)}catch{v("Upload failed. Please try again.")}}else v("Please select a species");else v("Please select at least one image")},disabled:!S,isLoading:C,children:["Upload ",o.length>0?`(${o.length})`:""]})]})]})})},W=e=>null==e?{variant:"info",label:"N/A"}:e>=80?{variant:"success",label:`${e}%`}:e>=60?{variant:"warning",label:`${e}%`}:{variant:"danger",label:`${e}%`},H=({species:e,filters:a,onFilterChange:t})=>s.jsxs("div",{className:"flex flex-wrap gap-4 p-4 bg-gray-50 rounded-lg mb-6",children:[s.jsxs("div",{className:"flex-1 min-w-[200px]",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Species"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none",value:a.speciesId||"",onChange:e=>t({speciesId:e.target.value||void 0,page:1}),children:[s.jsx("option",{value:"",children:"All Species"}),e.map(e=>s.jsx("option",{value:e.id,children:e.englishName},e.id))]})]}),s.jsxs("div",{className:"flex-1 min-w-[200px]",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Annotation Status"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none",value:a.annotationStatus||"all",onChange:e=>t({annotationStatus:e.target.value,page:1}),children:[s.jsx("option",{value:"all",children:"All Images"}),s.jsx("option",{value:"annotated",children:"Annotated"}),s.jsx("option",{value:"unannotated",children:"Unannotated"})]})]}),s.jsxs("div",{className:"flex-1 min-w-[200px]",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quality"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none",value:a.qualityFilter||"all",onChange:e=>t({qualityFilter:e.target.value,page:1}),children:[s.jsx("option",{value:"all",children:"All Quality"}),s.jsx("option",{value:"high",children:"High (80-100)"}),s.jsx("option",{value:"medium",children:"Medium (60-79)"}),s.jsx("option",{value:"low",children:"Low (0-59)"}),s.jsx("option",{value:"unscored",children:"Unscored"})]})]}),s.jsxs("div",{className:"flex-1 min-w-[200px]",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Sort By"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none",value:a.sortBy||"createdAt",onChange:e=>t({sortBy:e.target.value}),children:[s.jsx("option",{value:"createdAt",children:"Date Added"}),s.jsx("option",{value:"speciesName",children:"Species Name"}),s.jsx("option",{value:"annotationCount",children:"Annotation Count"}),s.jsx("option",{value:"qualityScore",children:"Quality Score"})]})]}),s.jsxs("div",{className:"flex-1 min-w-[150px]",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Order"}),s.jsxs("select",{className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none",value:a.sortOrder||"desc",onChange:e=>t({sortOrder:e.target.value}),children:[s.jsx("option",{value:"desc",children:"Newest First"}),s.jsx("option",{value:"asc",children:"Oldest First"})]})]})]}),G=({image:e,onView:a,onAnnotate:t,onDelete:l,isDeleting:i,isAnnotating:o,isSelected:d,onToggleSelect:c})=>s.jsxs("div",{className:"relative group bg-white rounded-lg shadow-sm border-2 overflow-hidden hover:shadow-md transition-all "+(d?"border-blue-500 ring-2 ring-blue-200":"border-gray-200"),children:[s.jsx("div",{className:"absolute top-2 left-2 z-10",children:s.jsx("input",{type:"checkbox",checked:d,onChange:e=>{e.stopPropagation(),c()},className:"w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500 cursor-pointer bg-white shadow-sm",title:d?"Deselect image":"Select image"})}),s.jsxs("div",{className:"relative aspect-[4/3] cursor-pointer",onClick:a,children:[s.jsx(n,{src:e.url,alt:e.speciesName,className:"w-full h-full object-cover"}),s.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center",children:s.jsx("span",{className:"opacity-0 group-hover:opacity-100 text-white font-medium transition-opacity",children:"Click to view"})}),s.jsx("div",{className:"absolute bottom-2 left-2",children:(()=>{const a=W(e.qualityScore);return s.jsx(r,{variant:a.variant,size:"sm",title:"Quality Score",children:a.label})})()}),s.jsx("div",{className:"absolute bottom-2 right-2",children:s.jsxs(r,{variant:e.annotationCount>0?"success":"warning",size:"sm",children:[e.annotationCount," annotations"]})})]}),s.jsxs("div",{className:"p-3",children:[s.jsx("h3",{className:"font-medium text-gray-900 truncate",title:e.speciesName,children:e.speciesName}),s.jsx("p",{className:"text-sm text-gray-500 mt-1",children:new Date(e.createdAt).toLocaleDateString()}),s.jsxs("div",{className:"flex gap-2 mt-3",children:[s.jsx(x,{variant:"secondary",size:"sm",onClick:a,className:"flex-1",children:"View"}),0===e.annotationCount&&s.jsx(x,{variant:"primary",size:"sm",onClick:t,isLoading:o,disabled:o,className:"flex-1",children:"Annotate"}),s.jsx(x,{variant:"danger",size:"sm",onClick:l,isLoading:i,disabled:i,children:s.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]})]}),V=({page:e,totalPages:a,total:t,pageSize:n,onPageChange:l})=>{const i=(e-1)*n+1,r=Math.min(e*n,t);return s.jsxs("div",{className:"flex items-center justify-between mt-6 pt-4 border-t",children:[s.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",i," to ",r," of ",t," images"]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(x,{variant:"secondary",size:"sm",disabled:e<=1,onClick:()=>l(e-1),children:"Previous"}),s.jsxs("span",{className:"px-4 py-2 text-sm text-gray-600",children:["Page ",e," of ",a]}),s.jsx(x,{variant:"secondary",size:"sm",disabled:e>=a,onClick:()=>l(e+1),children:"Next"})]})]})},J=({imageId:a,isOpen:t,onClose:n,onAnnotate:l,onDelete:o,isAnnotating:d,isDeleting:c})=>{const{data:m,isLoading:h}=(e=>j({queryKey:O.detail(e||""),queryFn:async()=>{if(!e)return null;try{return(await i.get(`/api/admin/images/${e}`)).data.data}catch(s){return b("Error fetching image details:",s instanceof Error?s:new Error(String(s))),null}},enabled:!!e,staleTime:6e4,gcTime:3e5}))(t?a:null),[u,p]=e.useState(!0);return t?s.jsx(B,{isOpen:t,onClose:n,title:"Image Details",size:"xl",children:h?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):m?s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"relative",children:[s.jsx("img",{src:m.url,alt:m.species?.englishName||"Bird image",className:"w-full rounded-lg"}),u&&m.annotations.map(e=>e.boundingBox?s.jsx("div",{className:"absolute border-2 border-blue-500 bg-blue-500 bg-opacity-20 rounded",style:{left:`${e.boundingBox.x}%`,top:`${e.boundingBox.y}%`,width:`${e.boundingBox.width}%`,height:`${e.boundingBox.height}%`},title:`${e.spanishTerm} (${e.englishTerm})`,children:s.jsx("span",{className:"absolute -top-6 left-0 bg-blue-600 text-white text-xs px-2 py-1 rounded whitespace-nowrap",children:e.spanishTerm})},e.id):null)]}),m.annotations.length>0&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",id:"showAnnotations",checked:u,onChange:e=>p(e.target.checked),className:"rounded text-blue-600"}),s.jsx("label",{htmlFor:"showAnnotations",className:"text-sm text-gray-600",children:"Show annotation overlays"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900",children:"Species"}),s.jsx("p",{className:"text-gray-600",children:m.species?.englishName||"Unknown"}),s.jsx("p",{className:"text-sm text-gray-500 italic",children:m.species?.scientificName}),s.jsx("p",{className:"text-sm text-gray-500",children:m.species?.spanishName})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-900",children:"Image Info"}),s.jsxs("p",{className:"text-sm text-gray-600",children:[m.width," x ",m.height]}),s.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[s.jsx("span",{className:"text-sm text-gray-500",children:"Quality:"}),(()=>{const e=W(m.qualityScore);return s.jsx(r,{variant:e.variant,size:"sm",children:e.label})})()]}),m.photographer&&s.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Photo by ",m.photographer,m.photographerUsername&&s.jsxs("span",{className:"text-gray-400",children:[" ","(@",m.photographerUsername,")"]})]}),s.jsxs("p",{className:"text-sm text-gray-500",children:["Added ",new Date(m.createdAt).toLocaleString()]})]})]}),s.jsxs("div",{children:[s.jsxs("h4",{className:"font-medium text-gray-900 mb-2",children:["Annotations (",m.annotations.length,")"]}),0===m.annotations.length?s.jsx("p",{className:"text-gray-500 text-sm",children:"No annotations yet"}):s.jsx("div",{className:"max-h-48 overflow-y-auto",children:s.jsxs("table",{className:"w-full text-sm",children:[s.jsx("thead",{className:"bg-gray-50",children:s.jsxs("tr",{children:[s.jsx("th",{className:"text-left py-2 px-3",children:"Spanish"}),s.jsx("th",{className:"text-left py-2 px-3",children:"English"}),s.jsx("th",{className:"text-left py-2 px-3",children:"Type"}),s.jsx("th",{className:"text-left py-2 px-3",children:"Status"}),s.jsx("th",{className:"text-left py-2 px-3",children:"Confidence"})]})}),s.jsx("tbody",{children:m.annotations.map(e=>s.jsxs("tr",{className:"border-b",children:[s.jsx("td",{className:"py-2 px-3 font-medium",children:e.spanishTerm}),s.jsx("td",{className:"py-2 px-3",children:e.englishTerm}),s.jsx("td",{className:"py-2 px-3",children:s.jsx(r,{variant:"info",size:"sm",children:e.annotationType})}),s.jsx("td",{className:"py-2 px-3",children:s.jsx(r,{variant:"approved"===e.status?"success":"rejected"===e.status?"danger":"warning",size:"sm",children:e.status})}),s.jsx("td",{className:"py-2 px-3",children:e.confidence?`${(100*e.confidence).toFixed(0)}%`:"-"})]},e.id))})]})})]}),s.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[0===m.annotations.length&&s.jsx(x,{variant:"primary",onClick:l,isLoading:d,disabled:d,children:"Generate Annotations"}),s.jsx(x,{variant:"danger",onClick:o,isLoading:c,disabled:c,children:"Delete Image"}),s.jsx(x,{variant:"secondary",onClick:n,children:"Close"})]})]}):s.jsx(g,{variant:"danger",children:"Failed to load image details"})}):null},_=({species:a,onToast:t,selectedImages:n,onSelectionChange:l})=>{const[r,m]=e.useState({page:1,pageSize:20,annotationStatus:"all",qualityFilter:"all",sortBy:"createdAt",sortOrder:"desc"}),[g,h]=e.useState(null),[u,v]=e.useState(null),[f,N]=e.useState(!1),[k,C]=e.useState([]),S=n??k,L=l??C,{data:A,isLoading:P,refetch:E}=((e={})=>{const{page:s=1,pageSize:a=20,speciesId:t,annotationStatus:n="all",qualityFilter:l="all",sortBy:r="createdAt",sortOrder:o="desc"}=e;return j({queryKey:O.list(e),queryFn:async()=>{try{const e=new URLSearchParams({page:s.toString(),pageSize:a.toString(),annotationStatus:n,qualityFilter:l,sortBy:r,sortOrder:o});return t&&e.append("speciesId",t),(await i.get(`/api/admin/images?${e}`)).data.data}catch(e){return b("Error fetching gallery images:",e instanceof Error?e:new Error(String(e))),{images:[],pagination:{total:0,page:1,pageSize:20,totalPages:0}}}},staleTime:3e4,gcTime:3e5})})(r),q=(()=>{const e=p();return y({mutationFn:async e=>(await i.delete(`/api/admin/images/${e}`)).data,onSuccess:()=>{e.invalidateQueries({queryKey:O.all})},onError:e=>{b("Error deleting image:",e instanceof Error?e:new Error(String(e)))}})})(),T=(()=>{const e=p();return y({mutationFn:async e=>(await i.post(`/api/admin/images/${e}/annotate`)).data,onSuccess:(s,a)=>{e.invalidateQueries({queryKey:O.detail(a)}),e.invalidateQueries({queryKey:O.all})},onError:e=>{b("Error annotating image:",e instanceof Error?e:new Error(String(e)))}})})();e.useEffect(()=>{L([])},[r.speciesId,r.annotationStatus,r.qualityFilter,L]);const D=e.useCallback(e=>{m(s=>({...s,...e}))},[]),I=e.useCallback(e=>{h(e)},[]),z=e.useCallback(async e=>{try{const s=await T.mutateAsync(e);t("success",`Generated ${s.annotationCount} annotations`),E()}catch{t("error","Failed to generate annotations")}},[T,t,E]),F=e.useCallback(async e=>{try{await q.mutateAsync(e),t("success","Image deleted successfully"),h(null),v(null),E()}catch{t("error","Failed to delete image")}},[q,t,E]),M=e.useCallback(e=>{m(s=>({...s,page:e}))},[]),$=e.useCallback(e=>{L(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])},[L]),Q=e.useCallback(()=>{const e=(A?.images||[]).map(e=>e.id);L(e)},[A?.images,L]),R=e.useCallback(()=>{L([])},[L]),K=e.useCallback(async()=>{if(0!==S.length)try{for(const e of S)await q.mutateAsync(e);t("success",`Deleted ${S.length} image(s) successfully`),L([]),E()}catch{t("error","Failed to delete selected images")}},[S,q,t,L,E]),W=e.useCallback(async()=>{if(0!==S.length)try{let e=0;for(const s of S){await T.mutateAsync(s)&&e++}t("success",`Generated annotations for ${e} image(s)`),L([]),E()}catch{t("error","Failed to generate annotations for selected images")}},[S,T,t,L,E]),_=A?.images||[],X=A?.pagination||{total:0,page:1,pageSize:20,totalPages:0},Y=_.map(e=>e.id),Z=Y.length>0&&Y.every(e=>S.includes(e));return s.jsxs("div",{children:[s.jsxs(o,{variant:"elevated",padding:"lg",children:[s.jsx(d,{title:"Image Gallery",subtitle:`Browse and manage ${X.total} collected images`}),s.jsxs(c,{children:[s.jsx("div",{className:"flex justify-end mb-4",children:s.jsxs(x,{variant:"primary",onClick:()=>N(!0),children:[s.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),"Upload Images"]})}),s.jsx(H,{species:a,filters:r,onFilterChange:D}),s.jsx(w,{selectedCount:S.length,onSelectAll:Q,onDeselectAll:R,onDelete:K,onAnnotate:W,isDeleting:q.isPending,isAnnotating:T.isPending,totalCount:Y.length,allSelected:Z}),P?s.jsxs("div",{className:"flex items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),s.jsx("span",{className:"ml-3 text-gray-600",children:"Loading images..."})]}):0===_.length?s.jsxs("div",{className:"text-center py-12 text-gray-500",children:[s.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),s.jsx("p",{className:"text-lg font-medium",children:"No images found"}),s.jsx("p",{className:"text-sm mt-1",children:"Try adjusting your filters or collect some images first."})]}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:_.map(e=>s.jsx(G,{image:e,onView:()=>I(e.id),onAnnotate:()=>z(e.id),onDelete:()=>v(e.id),isDeleting:q.isPending&&u===e.id,isAnnotating:T.isPending,isSelected:S.includes(e.id),onToggleSelect:()=>$(e.id)},e.id))}),s.jsx(V,{page:X.page,totalPages:X.totalPages,total:X.total,pageSize:X.pageSize,onPageChange:M})]})]})]}),g&&s.jsx(J,{imageId:g,isOpen:!!g,onClose:()=>h(null),onAnnotate:()=>z(g),onDelete:()=>F(g),isAnnotating:T.isPending,isDeleting:q.isPending}),s.jsx(B,{isOpen:!!u,onClose:()=>v(null),title:"Delete Image",size:"sm",children:s.jsxs("div",{className:"space-y-4",children:[s.jsx("p",{className:"text-gray-600",children:"Are you sure you want to delete this image? This will also delete all associated annotations. This action cannot be undone."}),s.jsxs("div",{className:"flex justify-end gap-3",children:[s.jsx(x,{variant:"secondary",onClick:()=>v(null),children:"Cancel"}),s.jsx(x,{variant:"danger",onClick:()=>u&&F(u),isLoading:q.isPending,children:"Delete"})]})]})}),s.jsx(U,{isOpen:f,onClose:()=>N(!1),species:a,onSuccess:()=>E(),onToast:t})]})},X=()=>{const{user:n,loading:i}=t(),{data:p=[],isLoading:j}=l(),{stats:y,quota:b,jobs:v,pendingImages:w,isLoading:C,refetchStats:S,collectMutation:L,annotateMutation:A,bulkDeleteMutation:P}=f(),{toasts:E,addToast:q,removeToast:T}=h(),[D,I]=e.useState("collection"),[z,F]=e.useState([]),[B,O]=e.useState(2),[Q,R]=e.useState([]),[K,U]=e.useState(!0),[W,H]=e.useState(!1),[G,V]=e.useState([]);if(i)return s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"Loading..."})]})});if(!n)return s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Authentication Required"}),s.jsx("p",{className:"text-gray-600 mb-4",children:"Please sign in to access image management."}),s.jsx(a,{to:"/login",className:"inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md",children:"Sign In"})]})});const J=j||C;return s.jsxs("div",{className:"min-h-screen bg-gray-50",children:[s.jsx("div",{className:"bg-white border-b border-gray-200 sticky top-0 z-10",children:s.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Image Management"}),s.jsx("p",{className:"text-gray-600 mt-1",children:"Collect bird images and manage AI annotations"})]}),s.jsx("div",{className:"flex items-center gap-4",children:s.jsx(a,{to:"/admin/annotations",className:"inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50",children:"View Annotations"})})]}),s.jsx("div",{className:"flex gap-4 mt-6 border-b border-gray-200",children:[{key:"collection",label:"Image Collection"},{key:"gallery",label:"Gallery"},{key:"annotation",label:"Batch Annotation"},{key:"statistics",label:"Statistics"},{key:"history",label:"Job History"}].map(e=>s.jsx("button",{onClick:()=>I(e.key),className:"px-4 py-2 font-medium border-b-2 transition-colors "+(D===e.key?"border-blue-600 text-blue-600":"border-transparent text-gray-600 hover:text-gray-900"),children:e.label},e.key))})]})}),s.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[J&&s.jsx(M,{activeTab:D}),!J&&s.jsxs(s.Fragment,{children:["collection"===D&&s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs(o,{variant:"elevated",padding:"lg",children:[s.jsx(d,{title:"Collect Images",subtitle:"Select species and configure collection parameters"}),s.jsx(c,{children:s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Bird Species"}),s.jsx(N,{species:p,selected:z,onChange:F,disabled:L.isPending})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Images per Species"}),s.jsx("input",{type:"number",min:1,max:10,value:B,onChange:e=>O(parseInt(e.target.value)||2),disabled:L.isPending,className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none disabled:bg-gray-100"}),s.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Recommended: 2-5 images per species"})]}),b&&b.unsplash.remaining<10&&s.jsxs(g,{variant:"warning",title:"Low API Quota",children:["Only ",b.unsplash.remaining," Unsplash requests remaining.",b.unsplash.resetTime&&s.jsxs("span",{children:[" Resets at ",new Date(b.unsplash.resetTime).toLocaleTimeString()]})]})]})}),s.jsx(m,{children:s.jsxs(x,{variant:"primary",onClick:async()=>{if(0!==z.length)try{await L.mutateAsync({speciesIds:z,imagesPerSpecies:B}),q("success",`Started collecting images for ${z.length} species`),F([])}catch{q("error","Failed to start image collection")}else q("error","Please select at least one species")},isLoading:L.isPending,disabled:0===z.length||L.isPending,children:["Collect Images (",z.length," species)"]})})]}),s.jsxs(o,{variant:"elevated",padding:"lg",children:[s.jsx(d,{title:"Active Jobs",subtitle:"Currently running collection and annotation jobs"}),s.jsx(c,{children:0===v.filter(e=>"running"===e.status||"pending"===e.status).length?s.jsxs("div",{className:"text-center py-8 text-gray-500",children:[s.jsx("svg",{className:"w-12 h-12 mx-auto mb-3 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),s.jsx("p",{children:"No active jobs"})]}):s.jsx("div",{className:"space-y-4",children:v.filter(e=>"running"===e.status||"pending"===e.status).map(e=>s.jsxs("div",{className:"border rounded-lg p-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("span",{className:"font-medium capitalize",children:e.type}),s.jsx(r,{variant:"running"===e.status?"primary":"warning",dot:!0,children:e.status})]}),s.jsx($,{value:e.progress,max:e.total,variant:"gradient",color:"primary",showLabel:!0,animated:"running"===e.status}),s.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:[e.progress," / ",e.total," completed"]})]},e.id))})})]})]}),"gallery"===D&&s.jsx(_,{species:p,onToast:q,selectedImages:G,onSelectionChange:V}),"annotation"===D&&s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs(o,{variant:"elevated",padding:"lg",children:[s.jsx(d,{title:"Start Annotation",subtitle:"Generate AI annotations for bird images"}),s.jsx(c,{children:s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{children:s.jsxs("label",{className:"flex items-center space-x-3",children:[s.jsx("input",{type:"radio",checked:K,onChange:()=>U(!0),disabled:A.isPending,className:"w-4 h-4 text-blue-600"}),s.jsxs("span",{className:"font-medium",children:["Annotate all un-annotated images (",y?.pendingAnnotation||0," images)"]})]})}),s.jsx("div",{children:s.jsxs("label",{className:"flex items-center space-x-3",children:[s.jsx("input",{type:"radio",checked:!K,onChange:()=>U(!1),disabled:A.isPending,className:"w-4 h-4 text-blue-600"}),s.jsx("span",{className:"font-medium",children:"Select specific images"})]})}),!K&&s.jsx("div",{className:"border rounded-lg p-4 max-h-64 overflow-y-auto",children:0===w.length?s.jsx("p",{className:"text-gray-500 text-center py-4",children:"No pending images"}):s.jsx("div",{className:"grid grid-cols-3 gap-2",children:w.map(e=>s.jsxs("label",{className:"relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all "+(Q.includes(e.id)?"border-blue-500 ring-2 ring-blue-200":"border-transparent hover:border-gray-300"),children:[s.jsx("input",{type:"checkbox",checked:Q.includes(e.id),onChange:s=>{s.target.checked?R([...Q,e.id]):R(Q.filter(s=>s!==e.id))},className:"sr-only"}),s.jsx("img",{src:e.url,alt:"Bird",className:"w-full h-20 object-cover"}),Q.includes(e.id)&&s.jsx("div",{className:"absolute top-1 right-1 bg-blue-600 rounded-full p-0.5",children:s.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:s.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]},e.id))})}),b&&b.anthropic.remaining<100&&s.jsxs(g,{variant:"warning",title:"Low API Quota",children:["Only ",b.anthropic.remaining," Anthropic requests remaining.",b.anthropic.resetTime&&s.jsxs("span",{children:[" Resets at ",new Date(b.anthropic.resetTime).toLocaleTimeString()]})]})]})}),s.jsx(m,{children:s.jsx(x,{variant:"primary",onClick:async()=>{try{if(K)await A.mutateAsync({all:!0}),q("success","Started annotation for all pending images");else{if(0===Q.length)return void q("error","Please select at least one image");await A.mutateAsync({imageIds:Q}),q("success",`Started annotation for ${Q.length} images`),R([])}}catch{q("error","Failed to start annotation")}},isLoading:A.isPending,disabled:A.isPending||!K&&0===Q.length||K&&0===(y?.pendingAnnotation||0),children:"Start Annotation"})})]}),s.jsxs(o,{variant:"elevated",padding:"lg",children:[s.jsx(d,{title:"Annotation Progress",subtitle:"Real-time annotation status"}),s.jsx(c,{children:0===v.filter(e=>"annotation"===e.type&&("running"===e.status||"pending"===e.status)).length?s.jsxs("div",{className:"text-center py-8 text-gray-500",children:[s.jsx("svg",{className:"w-12 h-12 mx-auto mb-3 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),s.jsx("p",{children:"No annotation jobs running"}),s.jsx("p",{className:"text-sm mt-1",children:"Start an annotation job to see progress here"})]}):s.jsx("div",{className:"space-y-4",children:v.filter(e=>"annotation"===e.type&&("running"===e.status||"pending"===e.status)).map(e=>s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(r,{variant:"running"===e.status?"success":"warning",dot:!0,children:"running"===e.status?"Processing":"Queued"}),s.jsxs("span",{className:"text-sm text-gray-500",children:["Started ",new Date(e.startedAt).toLocaleTimeString()]})]}),s.jsx($,{value:e.progress,max:e.total,variant:"striped",color:"success",size:"lg",showLabel:!0,label:"Annotation Progress",animated:!0}),s.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[s.jsxs("div",{className:"bg-green-50 rounded-lg p-2",children:[s.jsx("div",{className:"text-lg font-bold text-green-600",children:e.results?.annotated||0}),s.jsx("div",{className:"text-xs text-green-700",children:"Annotated"})]}),s.jsxs("div",{className:"bg-yellow-50 rounded-lg p-2",children:[s.jsx("div",{className:"text-lg font-bold text-yellow-600",children:e.total-e.progress}),s.jsx("div",{className:"text-xs text-yellow-700",children:"Remaining"})]}),s.jsxs("div",{className:"bg-red-50 rounded-lg p-2",children:[s.jsx("div",{className:"text-lg font-bold text-red-600",children:e.results?.failed||0}),s.jsx("div",{className:"text-xs text-red-700",children:"Failed"})]})]})]},e.id))})})]})]}),"statistics"===D&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsx(o,{variant:"elevated",padding:"md",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-3xl font-bold text-blue-600",children:y?.totalImages||0}),s.jsx("div",{className:"text-sm text-gray-600 mt-1",children:"Total Images"})]})}),s.jsx(o,{variant:"elevated",padding:"md",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-3xl font-bold text-yellow-600",children:y?.pendingAnnotation||0}),s.jsx("div",{className:"text-sm text-gray-600 mt-1",children:"Pending Annotation"})]})}),s.jsx(o,{variant:"elevated",padding:"md",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-3xl font-bold text-green-600",children:y?.annotated||0}),s.jsx("div",{className:"text-sm text-gray-600 mt-1",children:"Annotated"})]})}),s.jsx(o,{variant:"elevated",padding:"md",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-3xl font-bold text-red-600",children:y?.failed||0}),s.jsx("div",{className:"text-sm text-gray-600 mt-1",children:"Failed"})]})})]}),s.jsxs(o,{variant:"elevated",padding:"lg",children:[s.jsx(d,{title:"API Quota Status",subtitle:"Current usage and limits"}),s.jsx(c,{children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-700 mb-2",children:"Unsplash API"}),s.jsx($,{value:b?.unsplash.remaining||0,max:b?.unsplash.limit||50,variant:"gradient",color:(b?.unsplash.remaining||0)<10?"danger":(b?.unsplash.remaining||0)<25?"warning":"success",showLabel:!0,label:"Requests Remaining"}),s.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:[b?.unsplash.remaining||0," / ",b?.unsplash.limit||50," requests",b?.unsplash.resetTime&&s.jsxs("span",{className:"ml-2",children:["(Resets: ",new Date(b.unsplash.resetTime).toLocaleString(),")"]})]})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"font-medium text-gray-700 mb-2",children:"Anthropic API"}),s.jsx($,{value:b?.anthropic.remaining||0,max:b?.anthropic.limit||1e3,variant:"gradient",color:(b?.anthropic.remaining||0)<100?"danger":(b?.anthropic.remaining||0)<500?"warning":"success",showLabel:!0,label:"Tokens Remaining"}),s.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:[b?.anthropic.remaining||0," / ",b?.anthropic.limit||1e3," requests",b?.anthropic.resetTime&&s.jsxs("span",{className:"ml-2",children:["(Resets: ",new Date(b.anthropic.resetTime).toLocaleString(),")"]})]})]})]})})]}),s.jsxs(o,{variant:"elevated",padding:"lg",children:[s.jsx(d,{title:"Images by Species",subtitle:"Distribution of collected images"}),s.jsx(c,{children:y?.bySpecies&&Object.keys(y.bySpecies).length>0?s.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:Object.entries(y.bySpecies).sort(([,e],[,s])=>s-e).slice(0,12).map(([e,a])=>{const t=p.find(s=>s.id===e);return s.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[s.jsx("div",{className:"text-xl font-bold text-gray-800",children:a}),s.jsx("div",{className:"text-xs text-gray-600 truncate",title:t?.englishName||e,children:t?.englishName||e})]},e)})}):s.jsx("p",{className:"text-gray-500 text-center py-4",children:"No images collected yet"})})]})]}),"history"===D&&s.jsxs(o,{variant:"elevated",padding:"lg",children:[s.jsx(d,{title:"Job History",subtitle:"Recent collection and annotation jobs"}),s.jsx(c,{children:0===v.length?s.jsxs("div",{className:"text-center py-8 text-gray-500",children:[s.jsx("svg",{className:"w-12 h-12 mx-auto mb-3 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),s.jsx("p",{children:"No jobs yet"}),s.jsx("p",{className:"text-sm mt-1",children:"Start collecting or annotating images to see job history"})]}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"border-b border-gray-200",children:[s.jsx("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Type"}),s.jsx("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Status"}),s.jsx("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Progress"}),s.jsx("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Started"}),s.jsx("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Completed"}),s.jsx("th",{className:"text-left py-3 px-4 font-medium text-gray-600",children:"Results"})]})}),s.jsx("tbody",{children:v.map(e=>s.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[s.jsx("td",{className:"py-3 px-4",children:s.jsx(r,{variant:"collection"===e.type?"primary":"info",size:"sm",children:e.type})}),s.jsx("td",{className:"py-3 px-4",children:s.jsx(r,{variant:"completed"===e.status?"success":"failed"===e.status?"danger":"running"===e.status?"primary":"warning",dot:!0,size:"sm",children:e.status})}),s.jsx("td",{className:"py-3 px-4",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx($,{value:e.progress,max:e.total,size:"sm",color:"failed"===e.status?"danger":"primary",className:"w-24"}),s.jsxs("span",{className:"text-sm text-gray-600",children:[e.progress,"/",e.total]})]})}),s.jsx("td",{className:"py-3 px-4 text-sm text-gray-600",children:new Date(e.startedAt).toLocaleString()}),s.jsx("td",{className:"py-3 px-4 text-sm text-gray-600",children:e.completedAt?new Date(e.completedAt).toLocaleString():"-"}),s.jsx("td",{className:"py-3 px-4",children:e.results?s.jsxs("div",{className:"text-sm",children:["collection"===e.type&&s.jsxs("span",{className:"text-green-600",children:[e.results.collected," collected"]}),"annotation"===e.type&&s.jsxs(s.Fragment,{children:[s.jsxs("span",{className:"text-green-600",children:[e.results.annotated," annotated"]}),e.results.failed&&e.results.failed>0&&s.jsxs("span",{className:"text-red-600 ml-2",children:[e.results.failed," failed"]})]})]}):e.error?s.jsx("span",{className:"text-sm text-red-600",title:e.error,children:"Error"}):"-"})]},e.id))})]})})})]})]})]}),s.jsx(u,{toasts:E,onRemove:T}),s.jsx(k,{isOpen:W,onClose:()=>H(!1),onConfirm:async()=>{try{const e=await P.mutateAsync(G);q("success",e.message),V([]),H(!1),S()}catch{q("error","Failed to delete images")}},count:G.length,isDeleting:P.isPending})]})};export{X as ImageManagementPage,X as default};
