import{u as e,a as r,b as t}from"./data-vendor-CRo3OXJP.js";import{u as a,e as s}from"./index-BZZsyLrt.js";const n="https://aves-production.up.railway.app",i={all:["srs"],dueTerms:e=>[...i.all,"due",e],userStats:e=>[...i.all,"stats",e],termProgress:(e,r)=>[...i.all,"term",e,r]},o=(r=20)=>{const{user:t}=a(),s=t?.id;return e({queryKey:i.dueTerms(s||""),queryFn:async()=>{if(!s)throw new Error("AUTHENTICATION_REQUIRED");const e=await fetch(`${n}/api/srs/due?limit=${r}`,{headers:{Authorization:`Bearer ${await(t?.getIdToken?.())||""}`}});if(401===e.status||403===e.status)throw new Error("AUTHENTICATION_FAILED");if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.message||"Failed to fetch due terms")}return(await e.json()).data||[]},enabled:!!s,staleTime:6e4,refetchInterval:3e5,retry:(e,r)=>(!(r instanceof Error)||"AUTHENTICATION_REQUIRED"!==r.message&&"AUTHENTICATION_FAILED"!==r.message)&&e<3})},u=()=>{const{user:r}=a(),t=r?.id;return e({queryKey:i.userStats(t||""),queryFn:async()=>{if(!t)throw new Error("AUTHENTICATION_REQUIRED");const e=await fetch(`${n}/api/srs/stats`,{headers:{Authorization:`Bearer ${await(r?.getIdToken?.())||""}`}});if(401===e.status||403===e.status)throw new Error("AUTHENTICATION_FAILED");if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(r.message||"Failed to fetch stats")}return(await e.json()).data},enabled:!!t,staleTime:12e4,retry:(e,r)=>(!(r instanceof Error)||"AUTHENTICATION_REQUIRED"!==r.message&&"AUTHENTICATION_FAILED"!==r.message)&&e<3})},d=()=>{const e=r(),{user:o}=a();return t({mutationFn:async e=>{if(!o?.id)throw new Error("Not authenticated");const r=await fetch(`${n}/api/srs/review`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await(o?.getIdToken?.())||""}`},body:JSON.stringify(e)});if(!r.ok)throw new Error("Failed to record review");return(await r.json()).data},onSuccess:(r,t)=>{o?.id&&(e.invalidateQueries({queryKey:i.dueTerms(o.id)}),e.invalidateQueries({queryKey:i.userStats(o.id)}),e.invalidateQueries({queryKey:i.termProgress(o.id,t.termId)}))},onError:e=>{s("Error recording review",e instanceof Error?e:new Error(String(e)))}})},c=()=>{const{user:e}=a(),{data:s=[],isLoading:c,error:w,refetch:T}=o(),{data:l,isLoading:h,error:E,refetch:A}=u(),m=d(),I=(()=>{const e=r(),{user:s}=a();return t({mutationFn:async e=>{if(!s?.id)throw new Error("Not authenticated");if(!(await fetch(`${n}/api/srs/discover`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await(s?.getIdToken?.())||""}`},body:JSON.stringify({termId:e})})).ok)throw new Error("Failed to mark term discovered")},onSuccess:()=>{s?.id&&e.invalidateQueries({queryKey:i.userStats(s.id)})}})})(),f=(e,r)=>e?r?r<1500?5:r<3e3?4:3:4:r&&r<2e3?1:0,y=(e=>{if(!e)return null;const r=e.message;return"AUTHENTICATION_REQUIRED"===r?"Please log in to access your practice terms":"AUTHENTICATION_FAILED"===r?"Your session has expired. Please log in again":r.includes("Network")||r.includes("fetch")?"Unable to connect. Please check your internet connection":r||"An error occurred"})(w||E||m.error),g=!!e?.id,N=new Date,v=new Date(N.getTime()+864e5),p=new Date(N.getTime()+6048e5),R={next24h:s.filter(e=>{if(!e.nextReviewAt)return!1;const r=new Date(e.nextReviewAt);return r>N&&r<=v}),next7d:s.filter(e=>{if(!e.nextReviewAt)return!1;const r=new Date(e.nextReviewAt);return r>v&&r<=p})},D=s.filter(e=>e.nextReviewAt&&new Date(e.nextReviewAt)>N).map(e=>new Date(e.nextReviewAt)).sort((e,r)=>e.getTime()-r.getTime())[0]||null;return{dueTerms:s,stats:l,dueCount:s.length,upcomingReviews:R,nextReviewDate:D,isLoading:c||h,isAuthenticated:g,requiresAuth:!g,error:y,recordReview:m.mutateAsync,markDiscovered:I.mutateAsync,calculateQuality:f,refresh:()=>{T(),A()},isRecording:m.isPending,recordError:m.error}};export{c as a,o as b,u};
