import{e,w as t}from"./index-BZZsyLrt.js";import{c as a}from"./data-vendor-CRo3OXJP.js";class s extends Error{constructor(e,t,a,r){super(e),this.code=t,this.statusCode=a,this.details=r,this.name="AppError",Object.setPrototypeOf(this,s.prototype)}toJSON(){return{name:this.name,message:this.message,code:this.code,statusCode:this.statusCode,details:this.details}}}class r extends s{constructor(e,t,a){super(e,"NETWORK_ERROR",t,a),this.name="NetworkError",Object.setPrototypeOf(this,r.prototype)}}class i extends s{constructor(e,t){super(e,"STORAGE_ERROR",void 0,t),this.name="StorageError",Object.setPrototypeOf(this,i.prototype)}}function n(e){return function(e){return e instanceof s}(e)?e:e instanceof Error?new s(e.message,"UNKNOWN_ERROR",void 0,{originalError:e.name}):new s("An unknown error occurred","UNKNOWN_ERROR",void 0,{error:String(e)})}const o=new class{dbName="aves-learning-db";dbVersion=1;db=null;staticData={annotations:[],species:[],exercises:[]};async initialize(){await this.loadStaticData(),await this.initIndexedDB(),this.migrateLocalStorage()}async loadStaticData(){try{const e="/aves/",t=await fetch(`${e}data/annotations.json`);this.staticData.annotations=await t.json();const a=await fetch(`${e}data/species.json`);this.staticData.species=await a.json();try{const t=await fetch(`${e}data/exercises.json`);this.staticData.exercises=await t.json()}catch{this.staticData.exercises=[]}}catch(t){e("Failed to load static data:",t instanceof Error?t:new Error(String(t))),this.loadEmbeddedData()}}loadEmbeddedData(){this.staticData.annotations=[{id:"1",imageId:"cardinal-1",boundingBox:{x:.15,y:.1,width:.1,height:.05},type:"anatomical",spanishTerm:"pico",englishTerm:"beak",pronunciation:"PEE-koh",difficultyLevel:1,isVisible:!0,createdAt:new Date,updatedAt:new Date},{id:"2",imageId:"cardinal-1",boundingBox:{x:.2,y:.15,width:.08,height:.05},type:"color",spanishTerm:"plumas rojas",englishTerm:"red feathers",pronunciation:"PLOO-mahs ROH-hahs",difficultyLevel:2,isVisible:!0,createdAt:new Date,updatedAt:new Date}],this.staticData.species=[{id:"1",scientificName:"Cardinalis cardinalis",englishName:"Northern Cardinal",spanishName:"Cardenal Rojo",orderName:"Passeriformes",familyName:"Cardinalidae",genus:"Cardinalis",habitats:["forest","urban"],sizeCategory:"small",primaryColors:["red","black"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1606567595334-d39972c85dfd?w=800",descriptionSpanish:"Ave distintiva de color rojo brillante con cresta prominente.",descriptionEnglish:"Distinctive bright red bird with prominent crest.",funFact:"Cardinals are one of the few bird species where both males and females sing.",annotationCount:2},{id:"2",scientificName:"Cyanocitta cristata",englishName:"Blue Jay",spanishName:"Arrendajo Azul",orderName:"Passeriformes",familyName:"Corvidae",genus:"Cyanocitta",habitats:["forest","urban","garden"],sizeCategory:"medium",primaryColors:["blue","white","black"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1591608971362-f08b2a75731a?w=800",descriptionSpanish:"Ave inteligente con plumaje azul brillante y cresta distintiva.",descriptionEnglish:"Intelligent bird with bright blue plumage and distinctive crest.",funFact:"Blue Jays can mimic hawk calls to scare other birds away from food.",annotationCount:2},{id:"3",scientificName:"Turdus migratorius",englishName:"American Robin",spanishName:"Petirrojo Americano",orderName:"Passeriformes",familyName:"Turdidae",genus:"Turdus",habitats:["forest","urban","garden","grassland"],sizeCategory:"medium",primaryColors:["red","brown","gray"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1552728089-57bdde30beb3?w=800",descriptionSpanish:"Ave común con pecho anaranjado rojizo distintivo.",descriptionEnglish:"Common bird with distinctive reddish-orange breast.",funFact:"Robins can produce three broods in one year and are often the first sign of spring.",annotationCount:2},{id:"4",scientificName:"Zenaida macroura",englishName:"Mourning Dove",spanishName:"Paloma Huilota",orderName:"Columbiformes",familyName:"Columbidae",genus:"Zenaida",habitats:["urban","grassland","desert"],sizeCategory:"medium",primaryColors:["brown","gray","pink"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1596071915134-94f36f1d3188?w=800",descriptionSpanish:"Ave gentil conocida por su canto melancólico.",descriptionEnglish:"Gentle bird known for its melancholic cooing song.",funFact:"Mourning Doves can drink water by suction, unlike most birds.",annotationCount:2},{id:"5",scientificName:"Passer domesticus",englishName:"House Sparrow",spanishName:"Gorrión Común",orderName:"Passeriformes",familyName:"Passeridae",genus:"Passer",habitats:["urban","garden"],sizeCategory:"small",primaryColors:["brown","gray","black"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1521651201144-634f700b36ef?w=800",descriptionSpanish:"Una de las aves más adaptables del mundo.",descriptionEnglish:"One of the most adaptable birds in the world.",funFact:"House Sparrows were introduced to North America in 1851.",annotationCount:2},{id:"6",scientificName:"Spinus tristis",englishName:"American Goldfinch",spanishName:"Jilguero Americano",orderName:"Passeriformes",familyName:"Fringillidae",genus:"Spinus",habitats:["meadow","garden","forest edge"],sizeCategory:"small",primaryColors:["yellow","black","white"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1580774998750-bfb65320b286?w=800",descriptionSpanish:"Ave pequeña con brillante plumaje amarillo en verano.",descriptionEnglish:"Small bird with bright yellow plumage in summer.",funFact:"Goldfinches are strict vegetarians and even feed their young seeds.",annotationCount:2},{id:"7",scientificName:"Agelaius phoeniceus",englishName:"Red-winged Blackbird",spanishName:"Tordo Sargento",orderName:"Passeriformes",familyName:"Icteridae",genus:"Agelaius",habitats:["wetland","marsh","meadow"],sizeCategory:"medium",primaryColors:["black","red","yellow"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1588690203882-81b0d1a39b51?w=800",descriptionSpanish:"Ave con distintivas manchas rojas y amarillas en las alas.",descriptionEnglish:"Bird with distinctive red and yellow shoulder patches.",funFact:"Males fiercely defend their territories and may have up to 15 females.",annotationCount:2},{id:"8",scientificName:"Ardea herodias",englishName:"Great Blue Heron",spanishName:"Garza Azulada",orderName:"Pelecaniformes",familyName:"Ardeidae",genus:"Ardea",habitats:["wetland","coastal","lake"],sizeCategory:"large",primaryColors:["blue","gray","white"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1604608672516-f1b9a53a4ed6?w=800",descriptionSpanish:"El ave zancuda más grande de América del Norte.",descriptionEnglish:"The largest wading bird in North America.",funFact:"Herons can strike at prey at lightning speed with their dagger-like bills.",annotationCount:2},{id:"9",scientificName:"Archilochus colubris",englishName:"Ruby-throated Hummingbird",spanishName:"Colibrí Garganta de Rubí",orderName:"Apodiformes",familyName:"Trochilidae",genus:"Archilochus",habitats:["forest","garden","meadow"],sizeCategory:"small",primaryColors:["green","red","white"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1520808663317-647b476a81b9?w=800",descriptionSpanish:"El único colibrí que anida al este del Mississippi.",descriptionEnglish:"The only hummingbird that nests east of the Mississippi.",funFact:"Their wings beat about 53 times per second and they can fly backwards.",annotationCount:2},{id:"10",scientificName:"Haliaeetus leucocephalus",englishName:"Bald Eagle",spanishName:"Águila Calva",orderName:"Accipitriformes",familyName:"Accipitridae",genus:"Haliaeetus",habitats:["coastal","lake","river","forest"],sizeCategory:"large",primaryColors:["brown","white","yellow"],conservationStatus:"LC",primaryImageUrl:"https://images.unsplash.com/photo-1611689342806-0863700ce1e4?w=800",descriptionSpanish:"El símbolo nacional de los Estados Unidos.",descriptionEnglish:"The national symbol of the United States.",funFact:"Bald Eagles can see fish from a mile away and dive at speeds up to 100 mph.",annotationCount:2}]}async initIndexedDB(){return new Promise((t,a)=>{const s=indexedDB.open(this.dbName,this.dbVersion);s.onerror=()=>{e("Failed to open IndexedDB"),a(s.error)},s.onsuccess=()=>{this.db=s.result,t()},s.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("interactions")){const e=t.createObjectStore("interactions",{keyPath:"id",autoIncrement:!0});e.createIndex("annotationId","annotationId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}if(!t.objectStoreNames.contains("progress")){t.createObjectStore("progress",{keyPath:"sessionId"}).createIndex("lastUpdated","lastUpdated",{unique:!1})}if(!t.objectStoreNames.contains("exerciseResults")){const e=t.createObjectStore("exerciseResults",{keyPath:"id",autoIncrement:!0});e.createIndex("exerciseId","exerciseId",{unique:!1}),e.createIndex("completedAt","completedAt",{unique:!1})}}})}migrateLocalStorage(){const t=localStorage.getItem("aves-progress");if(t)try{const e=JSON.parse(t);this.saveProgress(e),localStorage.removeItem("aves-progress")}catch(a){e("Failed to migrate localStorage:",a instanceof Error?a:new Error(String(a)))}}async getAnnotations(e){return e?this.staticData.annotations.filter(t=>t.imageId===e):this.staticData.annotations}async getSpecies(e){let t=[...this.staticData.species];if(e){if(e.habitat&&(t=t.filter(t=>t.habitats?.includes(e.habitat)??!1)),e.sizeCategory&&(t=t.filter(t=>t.sizeCategory===e.sizeCategory)),e.primaryColor&&(t=t.filter(t=>t.primaryColors?.includes(e.primaryColor)??!1)),e.searchTerm){const a=e.searchTerm.toLowerCase();t=t.filter(e=>e.spanishName.toLowerCase().includes(a)||e.englishName.toLowerCase().includes(a)||e.scientificName.toLowerCase().includes(a))}e.orderName&&(t=t.filter(t=>t.orderName===e.orderName)),e.familyName&&(t=t.filter(t=>t.familyName===e.familyName))}return t}async getExercises(e){return e?this.staticData.exercises.filter(t=>t.type===e):this.staticData.exercises}async saveInteraction(e){if(!this.db)throw new i("Database not initialized");const t=this.db.transaction(["interactions"],"readwrite").objectStore("interactions"),a={...e,userSessionId:this.getCurrentSessionId(),timestamp:new Date};await new Promise((e,s)=>{const r=t.add(a);r.onsuccess=()=>e(),r.onerror=()=>s(new i("Failed to save interaction",{error:r.error}))})}async getInteractions(e){if(!this.db)throw new i("Database not initialized");const t=this.db.transaction(["interactions"],"readonly").objectStore("interactions");return new Promise((a,s)=>{const r=t.getAll();r.onsuccess=()=>{const t=r.result.filter(t=>t.userSessionId===e);a(t)},r.onerror=()=>s(new i("Failed to get interactions",{error:r.error}))})}async saveProgress(e){if(!this.db)return void localStorage.setItem("aves-progress-backup",JSON.stringify(e));const t=this.db.transaction(["progress"],"readwrite").objectStore("progress"),a={...e,lastUpdated:new Date};await new Promise((e,s)=>{const r=t.put(a);r.onsuccess=()=>e(),r.onerror=()=>s(new i("Failed to save progress",{error:r.error}))})}async getProgress(e){if(!this.db){const e=localStorage.getItem("aves-progress-backup");return e?JSON.parse(e):null}const t=this.db.transaction(["progress"],"readonly").objectStore("progress");return new Promise((a,s)=>{const r=t.get(e);r.onsuccess=()=>a(r.result||null),r.onerror=()=>s(new i("Failed to get progress",{error:r.error}))})}async saveExerciseResult(e){if(!this.db)throw new i("Database not initialized");const t=this.db.transaction(["exerciseResults"],"readwrite").objectStore("exerciseResults"),a={...e,completedAt:new Date};await new Promise((e,s)=>{const r=t.add(a);r.onsuccess=()=>e(),r.onerror=()=>s(new i("Failed to save exercise result",{error:r.error}))})}async getExerciseResults(e){if(!this.db)throw new i("Database not initialized");const t=this.db.transaction(["exerciseResults"],"readonly").objectStore("exerciseResults");return new Promise((a,s)=>{const r=t.getAll();r.onsuccess=()=>{const t=r.result.filter(t=>t.sessionId===e);a(t)},r.onerror=()=>s(new i("Failed to get exercise results",{error:r.error}))})}async exportData(){const e=this.getCurrentSessionId(),t={interactions:await this.getInteractions(e),progress:await this.getProgress(e),exerciseResults:await this.getExerciseResults(e),exportedAt:(new Date).toISOString()};return JSON.stringify(t,null,2)}async importData(t){try{const e=JSON.parse(t);if(e.interactions&&Array.isArray(e.interactions))for(const t of e.interactions)await this.saveInteraction(t);if(e.progress&&await this.saveProgress(e.progress),e.exerciseResults&&Array.isArray(e.exerciseResults))for(const t of e.exerciseResults)await this.saveExerciseResult(t)}catch(a){throw e("Failed to import data:",a instanceof Error?a:new Error(String(a))),new i("Invalid import data format",{error:a})}}getCurrentSessionId(){let e=sessionStorage.getItem("aves-session-id");return e||(e=`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem("aves-session-id",e)),e}async clearAllData(){if(this.db){const e=this.db.transaction(["interactions","progress","exerciseResults"],"readwrite");await Promise.all([this.clearObjectStore(e,"interactions"),this.clearObjectStore(e,"progress"),this.clearObjectStore(e,"exerciseResults")])}localStorage.clear(),sessionStorage.clear()}clearObjectStore(e,t){return new Promise((a,s)=>{const r=e.objectStore(t).clear();r.onsuccess=()=>a(),r.onerror=()=>s(r.error)})}};o.initialize().catch(e);const c={VITE_API_URL:"https://aves-production.up.railway.app"},l=window.location.hostname.includes("github.io");const d=new class{axiosInstance=null;useClientStorage;constructor(){const e=window.location.pathname.includes("/admin");if(this.useClientStorage=l&&!e,!this.useClientStorage||e){const e=c,t=e?.VITE_API_URL;this.axiosInstance=a.create({baseURL:t,timeout:1e4,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}const t=c,s=t?.VITE_API_URL;!e&&l||(a.defaults.baseURL=s)}setupInterceptors(){this.axiosInstance&&(this.axiosInstance.interceptors.request.use(e=>{const t=sessionStorage.getItem("aves-session-id");return t&&(e.headers["X-Session-Id"]=t),e},e=>Promise.reject(e)),this.axiosInstance.interceptors.response.use(e=>e,e=>(503===e.response?.status&&(t("Backend unavailable, switching to client storage"),this.useClientStorage=!0),Promise.reject(e))))}async getAnnotations(t){if(this.useClientStorage)return o.getAnnotations(t);try{return(await this.axiosInstance.get("/api/annotations",{params:{imageId:t}})).data.data}catch(a){return e("API error, falling back to client storage:",a instanceof Error?a:new Error(String(a))),this.handleApiError(a),o.getAnnotations(t)}}async createAnnotation(t){if(this.useClientStorage)throw new r("Cannot create annotations in static mode",403);try{return(await this.axiosInstance.post("/api/annotations",t)).data.data}catch(e){throw this.handleApiError(e)}}async getSpecies(t){if(this.useClientStorage)return o.getSpecies(t);try{const e=await this.axiosInstance.get("/api/species",{params:t});return e.data.data||e.data.species||[]}catch(a){return e("API error, falling back to client storage:",a instanceof Error?a:new Error(String(a))),this.handleApiError(a),o.getSpecies(t)}}async getSpeciesById(t){if(this.useClientStorage){return(await this.getSpecies()).find(e=>e.id===t)||null}try{return(await this.axiosInstance.get(`/api/species/${t}`)).data}catch(a){e("API error fetching species by ID, falling back to list:",a instanceof Error?a:new Error(String(a))),this.handleApiError(a);return(await this.getSpecies()).find(e=>e.id===t)||null}}async getSimilarSpecies(t){if(this.useClientStorage){const e=await this.getSpecies(),a=e.find(e=>e.id===t);if(!a)return[];return e.filter(e=>e.id!==t&&(e.familyName===a.familyName||e.orderName===a.orderName||e.habitats?.some(e=>a.habitats?.includes(e)))).sort((e,t)=>e.familyName===a.familyName&&t.familyName!==a.familyName?-1:t.familyName===a.familyName&&e.familyName!==a.familyName?1:e.orderName===a.orderName&&t.orderName!==a.orderName?-1:t.orderName===a.orderName&&e.orderName!==a.orderName?1:0).slice(0,4)}try{return(await this.axiosInstance.get(`/api/species/${t}/similar`)).data.similarSpecies}catch(a){e("API error fetching similar species, using client logic:",a instanceof Error?a:new Error(String(a))),this.handleApiError(a);const s=await this.getSpecies(),r=s.find(e=>e.id===t);return r?s.filter(e=>e.id!==t&&(e.familyName===r.familyName||e.orderName===r.orderName)).slice(0,4):[]}}async getExercises(t){if(this.useClientStorage)return o.getExercises(t);try{return(await this.axiosInstance.get("/api/exercises",{params:{type:t}})).data.data}catch(a){return e("API error, falling back to client storage:",a instanceof Error?a:new Error(String(a))),this.handleApiError(a),o.getExercises(t)}}async submitExerciseAnswer(t,a){if(this.useClientStorage){const e={exerciseId:t,answer:a,correct:this.validateAnswer(t,a),timestamp:new Date,sessionId:this.getSessionId()};return await o.saveExerciseResult({...e,sessionId:e.sessionId||this.getSessionId()}),e}try{const e={exerciseId:t,answer:a,sessionId:this.getSessionId()};return(await this.axiosInstance.post("/api/exercises/submit",e)).data.data}catch(e){throw this.handleApiError(e)}}validateAnswer(e,t){return Math.random()>.3}getSessionId(){let e=sessionStorage.getItem("aves-session-id");return e||(e=`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem("aves-session-id",e)),e}async saveInteraction(e){if(this.useClientStorage)return o.saveInteraction(e);await this.axiosInstance.post("/api/vocabulary/interact",e)}async getInteractions(t){if(this.useClientStorage)return o.getInteractions(t);try{return(await this.axiosInstance.get("/api/vocabulary/interactions",{params:{sessionId:t}})).data.data}catch(a){return e("API error, falling back to client storage:",a instanceof Error?a:new Error(String(a))),this.handleApiError(a),o.getInteractions(t)}}async saveProgress(t){if(this.useClientStorage)return o.saveProgress(t);try{await this.axiosInstance.post("/api/progress",t)}catch(e){throw this.handleApiError(e)}}async getProgress(t){if(this.useClientStorage)return o.getProgress(t);try{return(await this.axiosInstance.get("/api/progress",{params:{sessionId:t}})).data.data}catch(a){return e("API error, falling back to client storage:",a instanceof Error?a:new Error(String(a))),this.handleApiError(a),o.getProgress(t)}}async exportUserData(){return o.exportData()}async importUserData(e){return o.importData(e)}async clearAllData(){return o.clearAllData()}isUsingClientStorage(){return this.useClientStorage}getStorageMode(){return this.useClientStorage?"client":"backend"}handleApiError(e){if(a.isAxiosError(e)){const t=e,a=t.response?.status,s=t.message||"Network request failed",i=t.response?.data;return new r(s,a,i)}const t=n(e);return new r(t.message,void 0,{originalError:t.code})}},m={annotations:{list:e=>d.getAnnotations(e),create:e=>d.createAnnotation(e)},species:{list:e=>d.getSpecies(e),get:e=>d.getSpeciesById(e),getSimilar:e=>d.getSimilarSpecies(e)},exercises:{list:e=>d.getExercises(e),submit:(e,t)=>d.submitExerciseAnswer(e,t)},vocabulary:{saveInteraction:e=>d.saveInteraction(e),getInteractions:e=>d.getInteractions(e)},progress:{save:e=>d.saveProgress(e),get:e=>d.getProgress(e)},utils:{export:()=>d.exportUserData(),import:e=>d.importUserData(e),clear:()=>d.clearAllData(),getMode:()=>d.getStorageMode()}};export{m as a};
